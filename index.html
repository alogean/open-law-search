<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Open Law Search</title>
        <link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
        <style>
            
        .header {
            margin-top: 45px;
        }
        
        .header h3 {
            margin-top: 0;
        }
        
        .header .form-query {
            padding-top: 15px;
        }
            
        .facets h5 {
            margin-top: 20px;
        }
        
        .facets .btn {
            text-align: left;
        }
        
        .facets .btn-group, .btn-group-vertical {
            display: block;
        }
        
        .facets .btn.active {
            color: #FFF;
            background-color: #428BCA;
            border-color: #357EBD;
            box-shadow: none;
            -webkit-box-shadow: none;
        }
        
        .container .gsc-control-cse {
            padding: 0;
        }
        
        .gsc-table-result {
            border-collapse: separate;
        }
        </style>
    </head>
    <body>
        <div class="container">
            
            <form id="form-search" onsubmit="return false;">
                
                <div class="row header">
                    <div class="col-lg-2">
                        <h3>Open Law Search</h3>
                    </div>
                    <div class="col-lg-6 form-query">
                        <input name="query" id="query" type="text" class="form-control" autofocus="autofocus" value="Product Liability">
                    </div>
                    <div class="col-lg-4 form-query">
                        <button onclick="filter()" class="btn btn-primary">Search</button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-lg-2 facets">
                        <h5>Regions</h5>
                        <div class="btn-group btn-group-vertical" data-toggle="buttons">
                            <label class="btn btn-default">
                                <input name="region" value="eu" type="checkbox" /> Europe Union
                            </label>
                            <label class="btn btn-default">
                                <input name="region" value="de" type="checkbox" /> Germany
                            </label>
                            <label class="btn btn-default">
                                <input name="region" value="at" type="checkbox" /> Austria
                            </label>
                            <label class="btn btn-default">
                                <input name="region" value="ch" type="checkbox" /> Switzerland
                            </label>
                        </div>
                        
                        <h5>Type</h5>
                        <div class="btn-group btn-group-vertical" data-toggle="buttons">
                            <label class="btn btn-default">
                                <input name="type" value="case_law" type="checkbox" /> Case Law
                            </label>
                            <label class="btn btn-default">
                                <input name="type" value="legislation" type="checkbox" /> Legislation
                            </label>
                            <label class="btn btn-default">
                                <input name="type" value="literature" type="checkbox" /> Literature
                            </label>
                        </div>

                        <h5>File Type</h5>
                        <div class="btn-group btn-group-vertical" data-toggle="buttons">
                            <label class="btn btn-default">
                                <input name="filetype" value="pdf" type="checkbox" /> PDF
                            </label>
                            <label class="btn btn-default">
                                <input name="filetype" value="rtf" type="checkbox" /> RTF
                            </label>
                            <label class="btn btn-default">
                                <input name="filetype" value="doc" type="checkbox" /> Word
                            </label>
                        </div>

                        <h5>Websites</h5>
                        <ul id="address" class="list-unstyled">
                            <li>-</li>
                        </ul>
                    </div>
                    
                    <div class="col-lg-10">
                        <gcse:searchresults-only gname="open-law-search"></gcse:searchresults-only>
                    </div>
                
                </form>
            </div>
        </div>

        <script src="components/jquery/jquery.min.js"></script>
        <script src="components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script>
            var sites = [];
            
            function filter() {

                var filters = [
                    'region',
                    'type'
                ];

                var values = {};

                $.each(filters, function (i, name) {

                    var vals = [];
                    $('input[name="' + name + '"]:checked').each(function() {
                        vals.push($(this).val());
                    });

                    if (vals.length > 0) {
                        values[name] = vals;
                    }
                });

                var matches = $.grep(sites, function(site) {

                    var all = true;
                    $.each(values, function (filter, vals) {
                        var match = false;
                        $.each(site[filter], function (i, value) {
                            if ($.inArray(value, vals) !== -1) {
                                match = true;
                                return false;
                            }
                        });
                        if (!match) {
                            all = false;
                        }
                    });
                    
                    return all;
                });
                
                console.log(matches);
                
                var addresses = $.map(matches, function (site) {
                    return 'site:' + site.address; 
                });
                
                var filetypes = [];
                $('input[name="filetype"]:checked').each(function() {
                    filetypes.push('filetype:' + $(this).val());
                });
                
                var element = google.search.cse.element.getElement('open-law-search');
                element.execute($('#query').val() + ' ' + addresses.join(' OR ') + ' ' + filetypes.join(' OR '));
                
                $('#address').empty();
                $.each(matches, function (i, site) {
                    $('#address').append('<li>' + site.address + '</li>');
                });
            }
            
            $(function () { 
                $.getJSON('sites.json', function(json) {
                    sites = json.sites;
                });
            });
            
            window.__gcse = {
                callback: function () {

                    $('input:checkbox').change(function () {
                        filter();
                    });

                    $('#form-search').submit(function () {
                        filter();
                        return false;
                    });
                    
                    filter();
                }
            };
        </script>
        <script>
          (function() {
            var cx = '013841539827124536855:qehav1erxea';
            var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
          })();
        </script>
    </body>
</html>